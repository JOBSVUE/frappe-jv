ARG FRAPPE_BRANCH=version-15

FROM frappe/build:${FRAPPE_BRANCH} AS builder

ARG FRAPPE_BRANCH=version-15
ARG FRAPPE_PATH=https://github.com/jobsvue/frappe-jv
ARG APPS_JSON_BASE64=WwogIHsgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vZnJhcHBlL2VycG5leHQiLCAgImJyYW5jaCI6ICJ2ZXJzaW9uLTE1IiB9LAogIHsgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vZnJhcHBlL2hybXMiLCAgICAgImJyYW5jaCI6ICJ2ZXJzaW9uLTE1IiB9LAogIHsgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vZnJhcHBlL2NybSIsICAgICAgImJyYW5jaCI6ICJtYWluIiB9LAogIHsgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vZnJhcHBlL2luc2lnaHRzIiwgImJyYW5jaCI6ICJtYWluIiB9LAogIHsgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vZnJhcHBlL2J1aWxkZXIiLCAgImJyYW5jaCI6ICJtYXN0ZXIiIH0sCiAgeyAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9mcmFwcGUvaGVscGRlc2siLCAiYnJhbmNoIjogIm1haW4iIH0sCiAgeyAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9mcmFwcGUvd2Vic2hvcCIsICJicmFuY2giOiAiZGV2ZWxvcCIgfSwKICB7ICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2ZyYXBwZS9vdHRvIiwgImJyYW5jaCI6ICJtYWluIiB9LAogIHsgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vZnJhcHBlL21haWwiLCAiYnJhbmNoIjogIm1haW4iIH0sCiAgeyAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9mcmFwcGUvZ2FtZXBsYW4iLCAiYnJhbmNoIjogIm1haW4iIH0sCiAgeyAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9mcmFwcGUvc3R1ZGlvIiwgImJyYW5jaCI6ICJkZXZlbG9wIiB9LAogIHsgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vZnJhcHBlL3RlbGVwaG9ueSIsICJicmFuY2giOiAiZGV2ZWxvcCIgfSwKICB7ICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2ZyYXBwZS93YWJhX2ludGVncmF0aW9uIiwgImJyYW5jaCI6ICJtYWluIiB9LAogIHsgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vZnJhcHBlL2Jsb2ciLCAiYnJhbmNoIjogImRldmVsb3AiIH0sCiAgeyAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9mcmFwcGUvd2lraSIsICJicmFuY2giOiAibWFzdGVyIiB9LAogIHsgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vZnJhcHBlL2VtYWlsX2RlbGl2ZXJ5X3NlcnZpY2UiLCAiYnJhbmNoIjogIm1haW4iIH0sCiAgeyAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9mcmFwcGUvdHdpbGlvLWludGVncmF0aW9uIiwgImJyYW5jaCI6ICJtYWluIiB9LAogIHsgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vZnJhcHBlL3RyYW5zbGF0b3IiLCAiYnJhbmNoIjogIm1haW4iIH0sCiAgeyAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9mcmFwcGUvcHJpbnRfZGVzaWduZXIiLCAiYnJhbmNoIjogIm1haW4iIH0KXQo=

USER root

RUN if [ -n "${APPS_JSON_BASE64}" ]; then \
    mkdir /opt/frappe && echo "${APPS_JSON_BASE64}" | base64 -d > /opt/frappe/apps.json; \
  fi

USER frappe

RUN export APP_INSTALL_ARGS="" && \
  if [ -n "${APPS_JSON_BASE64}" ]; then \
    export APP_INSTALL_ARGS="--apps_path=/opt/frappe/apps.json"; \
  fi && \
  bench init ${APP_INSTALL_ARGS}\
    --frappe-branch=${FRAPPE_BRANCH} \
    --frappe-path=${FRAPPE_PATH} \
    --no-procfile \
    --no-backups \
    --skip-redis-config-generation \
    --verbose \
    /home/frappe/frappe-bench && \
  cd /home/frappe/frappe-bench && \
  echo "{}" > sites/common_site_config.json && \
  find apps -mindepth 1 -path "*/.git" | xargs rm -fr

FROM frappe/base:${FRAPPE_BRANCH} AS backend

USER frappe

COPY --from=builder --chown=frappe:frappe /home/frappe/frappe-bench /home/frappe/frappe-bench

WORKDIR /home/frappe/frappe-bench

VOLUME [ \
  "/home/frappe/frappe-bench/sites", \
  "/home/frappe/frappe-bench/sites/assets", \
  "/home/frappe/frappe-bench/logs" \
]

CMD [ \
  "/home/frappe/frappe-bench/env/bin/gunicorn", \
  "--chdir=/home/frappe/frappe-bench/sites", \
  "--bind=0.0.0.0:8000", \
  "--threads=4", \
  "--workers=2", \
  "--worker-class=gthread", \
  "--worker-tmp-dir=/dev/shm", \
  "--timeout=120", \
  "--preload", \
  "frappe.app:application" \
]
